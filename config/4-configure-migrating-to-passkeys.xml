<data xmlns="urn:ietf:params:xml:ns:yang:ietf-restconf">
  <profiles xmlns="https://curity.se/ns/conf/base">
    <profile>
      <id>authentication-service</id>
      <type xmlns:auth="https://curity.se/ns/conf/profile/authentication">auth:authentication-service</type>
      <settings>
        <authentication-service xmlns="https://curity.se/ns/conf/profile/authentication">
          <authentication-actions>
            <authentication-action>
              <id>1-load-authenticator-switch</id>
              <switch xmlns="https://curity.se/ns/ext-conf/switch">
                <case>
                  <name>user-has-passkeys</name>
                  <condition-script>YXR0cmlidXRlcy5hY3Rpb24udXNlcl9leGlzdHNfY291bnQgPiAwICYmIGF0dHJpYnV0ZXMuYWN0aW9uLnBhc3NrZXlzX2NvdW50ID4gMA==</condition-script>
                  <action>trigger-passkeys-authenticator</action>
                </case>
                <case>
                  <name>user-has-no-passkeys</name>
                  <condition-script>YXR0cmlidXRlcy5hY3Rpb24ucGFzc2tleXNfY291bnQgPT0gMA==</condition-script>
                  <action>2-authentication-selector-sequence</action>
                </case>
                <fail-if-no-match>true</fail-if-no-match>
              </switch>
            </authentication-action>
            <authentication-action>
              <id>1-load-transformer</id>
              <script-transformer xmlns="https://curity.se/ns/ext-conf/script-transformer">
                <attributes-location>action-attributes</attributes-location>
                <transformation-procedure>1-load-transformer-proc</transformation-procedure>
              </script-transformer>
            </authentication-action>
            <authentication-action>
              <id>1-load-passkeys-query</id>
              <data-source-transformer xmlns="https://curity.se/ns/ext-conf/data-source-transformer">
                <attribute-data-source>
                  <data-source>passkeys-datasource</data-source>
                </attribute-data-source>
                <additional-attributes-to-include>passkeys_count</additional-attributes-to-include>
                <attributes-location>action-attributes</attributes-location>
              </data-source-transformer>
            </authentication-action>
            <authentication-action>
              <id>1-load-sequence</id>
              <sequence xmlns="https://curity.se/ns/ext-conf/sequence">
                <action>1-load-user-exists-query</action>
                <action>1-load-passkeys-query</action>
                <action>1-load-transformer</action>
                <action>1-load-authenticator-switch</action>
              </sequence>
            </authentication-action>
            <authentication-action>
              <id>1-load-user-exists-query</id>
              <data-source-transformer xmlns="https://curity.se/ns/ext-conf/data-source-transformer">
                <attribute-data-source>
                  <data-source>user-exists-datasource</data-source>
                </attribute-data-source>
                <additional-attributes-to-include>user_exists_count</additional-attributes-to-include>
                <attributes-location>action-attributes</attributes-location>
              </data-source-transformer>
            </authentication-action>
            <authentication-action>
              <id>2-authentication-selector</id>
              <selector xmlns="https://curity.se/ns/ext-conf/selector">
                <attribute-name>selected_authenticator</attribute-name>
                <option>
                  <title>Passkeys</title>
                  <string-attribute-value>passkeys</string-attribute-value>
                </option>
                <option>
                  <title>Password</title>
                  <string-attribute-value>password</string-attribute-value>
                </option>
                <title>Select Authentication Method</title>
              </selector>
            </authentication-action>
            <authentication-action>
              <id>2-authentication-selector-sequence</id>
              <sequence xmlns="https://curity.se/ns/ext-conf/sequence">
                <action>2-authentication-selector</action>
                <action>2-authentication-selector-transformer</action>
                <action>2-authentication-selector-switch</action>
              </sequence>
            </authentication-action>
            <authentication-action>
              <id>2-authentication-selector-switch</id>
              <switch xmlns="https://curity.se/ns/ext-conf/switch">
                <case>
                  <name>password</name>
                  <condition-script>YXR0cmlidXRlcy5hY3Rpb24uc2VsZWN0ZWRfYXV0aGVudGljYXRvciA9PT0gJ3Bhc3N3b3JkJwo=</condition-script>
                  <action>trigger-password-authenticator</action>
                </case>
                <case>
                  <name>passkeys-existing</name>
                  <condition-script>YXR0cmlidXRlcy5hY3Rpb24uc2VsZWN0ZWRfYXV0aGVudGljYXRvciA9PT0gJ3Bhc3NrZXlzJyAmJiBhdHRyaWJ1dGVzLmFjdGlvbi51c2VyX2V4aXN0c19jb3VudCA+IDA=</condition-script>
                  <action>trigger-passkeys-authenticator</action>
                </case>
                <case>
                  <name>passkeys-new</name>
                  <condition-script>YXR0cmlidXRlcy5hY3Rpb24uc2VsZWN0ZWRfYXV0aGVudGljYXRvciA9PT0gJ3Bhc3NrZXlzJyAmJiBhdHRyaWJ1dGVzLmFjdGlvbi51c2VyX2V4aXN0c19jb3VudCA9PT0gMA==</condition-script>
                  <action>3-passkeys-registration-sequence</action>
                </case>
              </switch>
            </authentication-action>
            <authentication-action>
              <id>2-authentication-selector-transformer</id>
              <script-transformer xmlns="https://curity.se/ns/ext-conf/script-transformer">
                <attributes-location>action-attributes</attributes-location>
                <transformation-procedure>2-authentication-selector-transformer-proc</transformation-procedure>
              </script-transformer>
            </authentication-action>
            <authentication-action>
              <id>3-passkeys-registration-create-account</id>
              <auto-create-account xmlns="https://curity.se/ns/ext-conf/auto-create-account">
                <account-manager>
                  <id>default-account-manager</id>
                </account-manager>
                <add-extra-attributes>true</add-extra-attributes>
                <email-attribute>email</email-attribute>
                <fail-on-conflicts>true</fail-on-conflicts>
              </auto-create-account>
            </authentication-action>
            <authentication-action>
              <id>3-passkeys-registration-form</id>
              <attribute-prompt xmlns="https://curity.se/ns/ext-conf/attribute-prompt">
                <required-attribute>
                  <name>given-name</name>
                  <attribute-source>action-attributes</attribute-source>
                  <required>true</required>
                  <type>text</type>
                </required-attribute>
                <required-attribute>
                  <name>family-name</name>
                  <attribute-source>action-attributes</attribute-source>
                  <required>true</required>
                  <type>text</type>
                </required-attribute>
                <required-attribute>
                  <name>phone-number</name>
                  <attribute-source>action-attributes</attribute-source>
                  <type>tel</type>
                </required-attribute>
              </attribute-prompt>
            </authentication-action>
            <authentication-action>
              <id>3-passkeys-registration-sequence</id>
              <sequence xmlns="https://curity.se/ns/ext-conf/sequence">
                <action>3-passkeys-registration-form</action>
                <action>3-passkeys-registration-transformer</action>
                <action>3-passkeys-registration-create-account</action>
                <action>trigger-passkeys-authenticator</action>
              </sequence>
            </authentication-action>
            <authentication-action>
              <id>3-passkeys-registration-transformer</id>
              <script-transformer xmlns="https://curity.se/ns/ext-conf/script-transformer">
                <transformation-procedure>3-passkeys-registration-transformer-proc</transformation-procedure>
              </script-transformer>
            </authentication-action>
            <authentication-action>
              <id>debug</id>
              <debug-attribute xmlns="https://curity.se/ns/ext-conf/debug-attribute"/>
            </authentication-action>
            <authentication-action>
              <id>trigger-passkeys-authenticator</id>
              <multi-factor-condition xmlns="https://curity.se/ns/ext-conf/multi-factor-condition">
                <attribute-enable-condition>
                  <second-factor>
                    <id>passkeys</id>
                  </second-factor>
                  <attribute-name>uses_passkey_logins</attribute-name>
                  <attribute-source>action-attributes</attribute-source>
                </attribute-enable-condition>
              </multi-factor-condition>
            </authentication-action>
            <authentication-action>
              <id>trigger-password-authenticator</id>
              <multi-factor-condition xmlns="https://curity.se/ns/ext-conf/multi-factor-condition">
                <attribute-enable-condition>
                  <second-factor>
                    <id>htmlform</id>
                  </second-factor>
                  <attribute-name>uses_password_logins</attribute-name>
                  <attribute-source>action-attributes</attribute-source>
                </attribute-enable-condition>
              </multi-factor-condition>
            </authentication-action>
          </authentication-actions>
          <authenticators>
            <authenticator>
              <id>email</id>
              <email>
                <account-manager>default-account-manager</account-manager>
              </email>
            </authenticator>
            <authenticator>
              <id>htmlform</id>
              <html-form xmlns="https://curity.se/ns/conf/authenticators/html-form">
                <account-manager>default-account-manager</account-manager>
                <credential-manager>default-credential-manager</credential-manager>
                <password-only>false</password-only>
              </html-form>
            </authenticator>
            <authenticator>
              <id>username</id>
              <authentication-actions>
                <login>1-load-sequence</login>
              </authentication-actions>
              <required-authenticator-for-registration>email</required-authenticator-for-registration>
              <username xmlns="https://curity.se/ns/ext-conf/username">
              </username>
            </authenticator>
            <authenticator>
              <id>passkeys</id>
              <required-authenticator-for-registration>email</required-authenticator-for-registration>
              <passkeys xmlns="https://curity.se/ns/conf/authenticators/passkeys">
                <account-manager>
                  <id>default-account-manager</id>
                </account-manager>
              </passkeys>
            </authenticator>
          </authenticators>
          <protocols>
            <protocol>
              <id>default-simple-protocol</id>
              <simple-api/>
            </protocol>
          </protocols>
        </authentication-service>
      </settings>
      <endpoints>
        <endpoint>
          <id>authentication-service-anonymous</id>
          <uri>/authn/anonymous</uri>
          <endpoint-kind>auth-anonymous</endpoint-kind>
        </endpoint>
        <endpoint>
          <id>authentication-service-authentication</id>
          <uri>/authn/authentication</uri>
          <endpoint-kind>auth-authentication</endpoint-kind>
        </endpoint>
        <endpoint>
          <id>authentication-service-registration</id>
          <uri>/authn/registration</uri>
          <endpoint-kind>auth-registration</endpoint-kind>
        </endpoint>
      </endpoints>
      <token-issuers>
        <default-token-issuer>
          <jwt-issuer-settings>
            <signing-key-id>default-signing-key</signing-key-id>
          </jwt-issuer-settings>
          <default-data-source>default-datasource</default-data-source>
        </default-token-issuer>
      </token-issuers>
    </profile>
    <profile>
      <id>token-service</id>
      <type xmlns:as="https://curity.se/ns/conf/profile/oauth">as:oauth-service</type>
      <expose-detailed-error-messages/>
      <settings>
        <authorization-server xmlns="https://curity.se/ns/conf/profile/oauth">
          <client-store>
            <config-backed>
              <client>
                <id>demo-web-client</id>
                <client-name>demo-web-client</client-name>
                <secret>Password1</secret>
                <redirect-uris>https://oauth.tools/callback/code</redirect-uris>
                <scope>openid</scope>
                <user-authentication>
                  <allowed-authenticators>username</allowed-authenticators>
                  <allowed-post-logout-redirect-uris>https://oauth.tools</allowed-post-logout-redirect-uris>
                </user-authentication>
                <allowed-origins>https://oauth.tools</allowed-origins>
                <capabilities>
                  <code>
                  </code>
                  <introspection/>
                </capabilities>
                <use-pairwise-subject-identifiers>
                  <sector-identifier>default</sector-identifier>
                </use-pairwise-subject-identifiers>
                <validate-port-on-loopback-interfaces>true</validate-port-on-loopback-interfaces>
              </client>
            </config-backed>
          </client-store>
        </authorization-server>
      </settings>
    </profile>
  </profiles>
  <facilities xmlns="https://curity.se/ns/conf/base">
    <data-sources>
      <data-source>
        <id>user-exists-datasource</id>
        <jdbc xmlns="https://curity.se/ns/ext-conf/jdbc">
          <attribute-query>SELECT count(1) as user_exists_count FROM accounts WHERE accounts.username = :subject;</attribute-query>
          <connection-string>data:text/plain;aes,v:S.VndLWU5GQ2JpckNGMXVqQw==.C6rkQ8glHxDrptc-lgebRg==.cqnzW3VinCTg8DHI4dsBmB5FNYyT98-M6QQk40gdgyXmKSH7D0pguWL4wfDZlHjx.snQWwiEav52rxIEwbEBFRvvUeZm07119jL6JftpZrE4=</connection-string>
          <standard-credentials-mode>
          </standard-credentials-mode>
          <driver>org.postgresql.Driver</driver>
          <password>data:text/plain;aes,v:S.NkwzZXgxeGt4QTdPNmxtYw==.anW7aS4bSZLersMbUyURAg==.cX90z9NOVPH6qQ8N661afg==.EbKO52sgfzt4lj7zkNxxgRN6b79g2y08UxL9-Oh-L6Y=</password>
          <username>postgres</username>
        </jdbc>
      </data-source>
      <data-source>
        <id>passkeys-datasource</id>
        <jdbc xmlns="https://curity.se/ns/ext-conf/jdbc">
          <attribute-query>SELECT count(1) as passkeys_count FROM devices JOIN accounts on accounts.account_id = devices.account_id where devices.device_type = 'webauthn' and accounts.username = :subject;</attribute-query>
          <connection-string>data:text/plain;aes,v:S.eVBpNjlTazdGRE5PZEFXZA==.mtNKK6ErgcSal3xDSsTraQ==.zDXYG4H1pttNy8DdfHrc0gDf3WZVdv56gR0CI2GNIOAXjxGxoUnojdtfoT9NIrgv.CYluQKznOuNfORkx44lV34uY6Aqk2CxJEoSceICyL4A=</connection-string>
          <standard-credentials-mode>
          </standard-credentials-mode>
          <driver>org.postgresql.Driver</driver>
          <password>data:text/plain;aes,v:S.QXpHVDUwN25LeThkRWx5Uw==.lN4eT1-bSoGK4Sz8pWSu8A==.aNIG6PqsR3gHlafcf-QowA==.4Tsh8WmintGEW6JGLmi61-FVEgWV1-rCdV9l_5wMSyk=</password>
          <username>postgres</username>
        </jdbc>
      </data-source>
    </data-sources>
  </facilities>
  <processing xmlns="https://curity.se/ns/conf/base">
    <procedures>
      <transformation-procedure>
        <id>1-load-transformer-proc</id>
        <script>LyoqCiAqIFRoaXMgaXMgYW4gZXhhbXBsZSBwcm9jZWR1cmUgdGhhdCBwZXJmb3JtcyBubyB0cmFuc2Zvcm1hdGlvbgogKiBAcGFyYW0ge3NlLmN1cml0eS5pZGVudGl0eXNlcnZlci5wcm9jZWR1cmVzLmNvbnRleHQuVHJhbnNmb3JtYXRpb25Qcm9jZWR1cmVDb250ZXh0fSBjb250ZXh0CiAqIEByZXR1cm5zIHsqfQogKi8KZnVuY3Rpb24gcmVzdWx0KGNvbnRleHQpIHsKICAKICB2YXIgYXR0cmlidXRlcyA9IGNvbnRleHQuYXR0cmlidXRlTWFwOwogIGlmIChhdHRyaWJ1dGVzLnVzZXJfZXhpc3RzX2NvdW50ID4gMCAmJiBhdHRyaWJ1dGVzLnBhc3NrZXlzX2NvdW50ID4gMCkgewogICAgYXR0cmlidXRlcy51c2VzX3Bhc3NrZXlfbG9naW5zID0gdHJ1ZTsKICB9CgogIHJldHVybiBhdHRyaWJ1dGVzOwp9</script>
      </transformation-procedure>
      <transformation-procedure>
        <id>2-authentication-selector-transformer-proc</id>
        <script>LyoqCiAqIFRoaXMgaXMgYW4gZXhhbXBsZSBwcm9jZWR1cmUgdGhhdCBwZXJmb3JtcyBubyB0cmFuc2Zvcm1hdGlvbgogKiBAcGFyYW0ge3NlLmN1cml0eS5pZGVudGl0eXNlcnZlci5wcm9jZWR1cmVzLmNvbnRleHQuVHJhbnNmb3JtYXRpb25Qcm9jZWR1cmVDb250ZXh0fSBjb250ZXh0CiAqIEByZXR1cm5zIHsqfQogKi8KZnVuY3Rpb24gcmVzdWx0KGNvbnRleHQpIHsKICAKICB2YXIgYXR0cmlidXRlcyA9IGNvbnRleHQuYXR0cmlidXRlTWFwOwogIGlmIChhdHRyaWJ1dGVzLnNlbGVjdGVkX2F1dGhlbnRpY2F0b3IgPT09ICdwYXNzd29yZCcpIHsKICAgICAgYXR0cmlidXRlcy51c2VzX3Bhc3N3b3JkX2xvZ2lucyA9IHRydWU7CiAgfSBlbHNlIHsKICAgICAgYXR0cmlidXRlcy51c2VzX3Bhc3NrZXlfbG9naW5zID0gdHJ1ZTsKICB9CgogIHJldHVybiBhdHRyaWJ1dGVzOwp9</script>
      </transformation-procedure>
      <transformation-procedure>
        <id>3-passkeys-registration-transformer-proc</id>
        <script>LyoqCiAqIFRoaXMgaXMgYW4gZXhhbXBsZSBwcm9jZWR1cmUgdGhhdCBwZXJmb3JtcyBubyB0cmFuc2Zvcm1hdGlvbgogKiBAcGFyYW0ge3NlLmN1cml0eS5pZGVudGl0eXNlcnZlci5wcm9jZWR1cmVzLmNvbnRleHQuVHJhbnNmb3JtYXRpb25Qcm9jZWR1cmVDb250ZXh0fSBjb250ZXh0CiAqIEByZXR1cm5zIHsqfQogKi8KZnVuY3Rpb24gcmVzdWx0KGNvbnRleHQpIHsKICB2YXIgYXR0cmlidXRlcyA9IGNvbnRleHQuYXR0cmlidXRlTWFwOwogIHZhciBhY3Rpb25BdHRyaWJ1dGVzID0gY29udGV4dC5hY3Rpb25BdHRyaWJ1dGVNYXA7CiAgCiAgYXR0cmlidXRlcy5lbWFpbCA9IGF0dHJpYnV0ZXMudXNlcm5hbWU7CiAgCiAgYXR0cmlidXRlcy5uYW1lID0ge307CiAgaWYgKGFjdGlvbkF0dHJpYnV0ZXNbImdpdmVuLW5hbWUiXSkgewogICAgYXR0cmlidXRlcy5uYW1lLmdpdmVuTmFtZSA9IGFjdGlvbkF0dHJpYnV0ZXNbImdpdmVuLW5hbWUiXTsKICB9CiAgaWYgKGFjdGlvbkF0dHJpYnV0ZXNbImZhbWlseS1uYW1lIl0pIHsKICAgIGF0dHJpYnV0ZXMubmFtZS5mYW1pbHlOYW1lID0gYWN0aW9uQXR0cmlidXRlc1siZmFtaWx5LW5hbWUiXTsKICB9CgogIGlmIChhY3Rpb25BdHRyaWJ1dGVzWyJwaG9uZS1udW1iZXIiXSkgewogICAgICBhdHRyaWJ1dGVzLnBob25lTnVtYmVycyA9IFt7IHZhbHVlOiBhY3Rpb25BdHRyaWJ1dGVzWyJwaG9uZS1udW1iZXIiXSwgcHJpbWFyeTogdHJ1ZSB9XTsKICB9CgogIGF0dHJpYnV0ZXMuYWN0aXZlID0gdHJ1ZTsKICByZXR1cm4gYXR0cmlidXRlczsKfQ==</script>
      </transformation-procedure>
    </procedures>
  </processing>  
</data>
